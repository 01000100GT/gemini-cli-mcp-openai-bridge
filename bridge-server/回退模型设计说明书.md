# Bridge-Server 回退模型功能设计说明书

## 1. 概述

### 1.1 背景
基于对 `gemini-cli` 项目的分析，发现其已经实现了完整的模型回退机制。当主模型（如 `gemini-2.5-pro`）遇到限速（429错误）或配额超限时，系统会自动切换到回退模型（如 `gemini-2.5-flash`）。

### 1.2 目标
在 `bridge-server` 项目中实现类似的回退模型功能，确保在主模型失败时能够自动切换到备用模型，提高服务的可用性和稳定性。

### 1.3 当前状态分析

#### Gemini-CLI 中的回退机制
- **默认模型**: `gemini-2.5-pro` (定义在 `packages/core/src/config/models.ts`)
- **回退模型**: `gemini-2.5-flash`
- **触发条件**: 
  - 429 限速错误
  - Pro 配额超限错误
  - 连续多次容量错误
- **实现位置**: 
  - `packages/cli/src/ui/App.tsx` - `flashFallbackHandler` 函数
  - `packages/core/src/utils/retry.ts` - `retryWithBackoff` 函数
  - `packages/core/src/config/config.ts` - 模型管理方法

#### Bridge-Server 当前状态
- 已有完整的 API Key 轮换机制
- 支持多账号配置
- 缺少模型回退功能
- 需要集成回退模型逻辑

## 2. 设计方案

### 2.1 配置设计

#### 2.1.1 环境变量配置
在 `.env` 文件中添加以下配置项：

```bash
# 回退模型配置
GEMINI_FALLBACK_MODEL=gemini-2.5-flash
GEMINI_ENABLE_FALLBACK=true
GEMINI_FALLBACK_MAX_RETRIES=3
GEMINI_FALLBACK_COOLDOWN_MINUTES=5

# 主模型配置
GEMINI_PRIMARY_MODEL=gemini-2.5-pro
```

#### 2.1.2 配置接口定义
```typescript
// src/types/fallback.ts
export interface FallbackConfig {
  enabled: boolean;
  primaryModel: string;
  fallbackModel: string;
  maxRetries: number;
  cooldownMinutes: number;
}

export interface ModelSwitchEvent {
  fromModel: string;
  toModel: string;
  reason: 'quota_exceeded' | 'rate_limit' | 'consecutive_failures';
  timestamp: Date;
  error?: Error;
}
```

### 2.2 核心组件设计

#### 2.2.1 FallbackService 类
```typescript
// src/fallback/FallbackService.ts
export class FallbackService {
  private config: FallbackConfig;
  private currentModel: string;
  private isInFallbackMode: boolean = false;
  private fallbackStartTime?: Date;
  private consecutiveFailures: number = 0;
  
  constructor(config: FallbackConfig) {
    this.config = config;
    this.currentModel = config.primaryModel;
  }
  
  // 检查是否应该触发回退
  shouldTriggerFallback(error: Error): boolean;
  
  // 执行模型回退
  async triggerFallback(error: Error): Promise<string>;
  
  // 检查是否可以恢复到主模型
  canRestorePrimaryModel(): boolean;
  
  // 恢复到主模型
  restorePrimaryModel(): void;
  
  // 获取当前模型
  getCurrentModel(): string;
  
  // 记录模型切换事件
  private logModelSwitch(event: ModelSwitchEvent): void;
}
```

#### 2.2.2 错误检测工具
```typescript
// src/fallback/errorDetection.ts
export function isQuotaExceededError(error: Error): boolean {
  // 检测配额超限错误
}

export function isRateLimitError(error: Error): boolean {
  // 检测限速错误
}

export function isProQuotaExceededError(error: Error): boolean {
  // 检测 Pro 模型配额超限
}

export function getErrorStatus(error: unknown): number | undefined {
  // 提取 HTTP 状态码
}
```

### 2.3 集成设计

#### 2.3.1 与现有 GeminiApiClient 集成
修改 `src/gemini-client.ts`：

```typescript
export class GeminiApiClient {
  private fallbackService: FallbackService;
  
  constructor(
    rotationService: RotationService,
    fallbackService: FallbackService
  ) {
    this.rotationService = rotationService;
    this.fallbackService = fallbackService;
  }
  
  async executeStreamRequest(
    messages: ChatCompletionMessage[],
    onChunk: (chunk: string) => void,
    onComplete: () => void,
    onError: (error: Error) => void
  ): Promise<void> {
    try {
      // 获取当前模型
      const currentModel = this.fallbackService.getCurrentModel();
      
      // 创建 ContentGenerator 配置
      const config = createContentGeneratorConfig({
        model: currentModel,
        apiKey: await this.rotationService.getApiKey()
      });
      
      // 执行请求...
      
    } catch (error) {
      // 检查是否需要回退
      if (this.fallbackService.shouldTriggerFallback(error)) {
        const fallbackModel = await this.fallbackService.triggerFallback(error);
        
        // 使用回退模型重试
        return this.executeStreamRequest(messages, onChunk, onComplete, onError);
      }
      
      throw error;
    }
  }
}
```

#### 2.3.2 配置加载器扩展
扩展 `src/rotation/ConfigLoader.ts`：

```typescript
export class ConfigLoader {
  // 现有方法...
  
  loadFallbackConfig(): FallbackConfig {
    return {
      enabled: process.env.GEMINI_ENABLE_FALLBACK !== 'false',
      primaryModel: process.env.GEMINI_PRIMARY_MODEL || 'gemini-2.5-pro',
      fallbackModel: process.env.GEMINI_FALLBACK_MODEL || 'gemini-2.5-flash',
      maxRetries: parseInt(process.env.GEMINI_FALLBACK_MAX_RETRIES || '3'),
      cooldownMinutes: parseInt(process.env.GEMINI_FALLBACK_COOLDOWN_MINUTES || '5')
    };
  }
}
```

### 2.4 持久化设计

#### 2.4.1 回退状态持久化
```typescript
// src/fallback/FallbackPersistence.ts
export interface FallbackState {
  isInFallbackMode: boolean;
  fallbackStartTime?: string;
  consecutiveFailures: number;
  lastSwitchReason?: string;
}

export class FallbackPersistence {
  private filePath: string;
  
  constructor(filePath: string) {
    this.filePath = filePath;
  }
  
  async saveState(state: FallbackState): Promise<void>;
  async loadState(): Promise<FallbackState | null>;
  async clearState(): Promise<void>;
}
```

## 3. 实现步骤

### 3.1 第一阶段：基础框架
1. 创建回退相关的类型定义
2. 实现 `FallbackService` 基础类
3. 实现错误检测工具函数
4. 扩展配置加载器

### 3.2 第二阶段：核心功能
1. 实现回退逻辑
2. 集成到 `GeminiApiClient`
3. 添加持久化支持
4. 实现恢复机制

### 3.3 第三阶段：优化和监控
1. 添加详细日志
2. 实现监控指标
3. 添加管理接口
4. 性能优化

## 4. 文件修改清单

### 4.1 新增文件
```
src/
├── fallback/
│   ├── FallbackService.ts
│   ├── FallbackPersistence.ts
│   ├── errorDetection.ts
│   └── index.ts
├── types/
│   └── fallback.ts
└── tests/
    └── fallback/
        ├── FallbackService.test.ts
        └── errorDetection.test.ts
```

### 4.2 修改文件
```
src/
├── gemini-client.ts          # 集成回退逻辑
├── index.ts                  # 初始化回退服务
├── rotation/
│   └── ConfigLoader.ts       # 添加回退配置加载
└── types/
    └── index.ts              # 导出回退类型
```

### 4.3 配置文件
```
.env                          # 添加回退配置项
.env example                  # 更新示例配置
```

## 5. 配置示例

### 5.1 完整的 .env 配置
```bash
# ===========================================
# 模型回退配置
# ===========================================

# 是否启用模型回退功能
GEMINI_ENABLE_FALLBACK=true

# 主模型（默认使用的模型）
GEMINI_PRIMARY_MODEL=gemini-2.5-pro

# 回退模型（主模型失败时使用）
GEMINI_FALLBACK_MODEL=gemini-2.5-flash

# 回退前的最大重试次数
GEMINI_FALLBACK_MAX_RETRIES=3

# 回退模式的冷却时间（分钟）
GEMINI_FALLBACK_COOLDOWN_MINUTES=5

# 回退状态持久化文件路径
GEMINI_FALLBACK_PERSISTENCE_FILE=./data/fallback-state.json

# ===========================================
# 现有的 API Key 轮换配置
# ===========================================

# 是否启用多账号轮换功能
MULTI_ACCOUNT_ENABLED=true

# 多账号配置（JSON格式）
GEMINI_MULTI_ACCOUNTS=[
  {
    "apiKey": "your-api-key-1",
    "name": "Account 1",
    "model": "gemini-2.5-pro"
  },
  {
    "apiKey": "your-api-key-2", 
    "name": "Account 2",
    "model": "gemini-2.5-pro"
  }
]

# 轮换策略
GEMINI_ROTATION_STRATEGY=round_robin

# 其他现有配置...
```

## 6. 监控和日志

### 6.1 关键指标
- 回退触发次数
- 回退持续时间
- 主模型恢复次数
- 错误类型分布
- 模型切换延迟

### 6.2 日志格式
```typescript
// 模型切换日志
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "INFO",
  "event": "model_switch",
  "from_model": "gemini-2.5-pro",
  "to_model": "gemini-2.5-flash",
  "reason": "quota_exceeded",
  "api_key_index": 1,
  "consecutive_failures": 3
}

// 模型恢复日志
{
  "timestamp": "2024-01-15T10:35:00Z",
  "level": "INFO",
  "event": "model_restore",
  "from_model": "gemini-2.5-flash",
  "to_model": "gemini-2.5-pro",
  "fallback_duration_minutes": 5
}
```

## 7. 测试策略

### 7.1 单元测试
- `FallbackService` 各方法测试
- 错误检测函数测试
- 配置加载测试
- 持久化功能测试

### 7.2 集成测试
- 端到端回退流程测试
- 与 API Key 轮换的协同测试
- 并发请求下的回退测试

### 7.3 压力测试
- 高频率错误场景测试
- 长时间回退模式测试
- 内存和性能影响测试

## 8. 部署和维护

### 8.1 部署检查清单
- [ ] 配置文件更新
- [ ] 持久化目录权限
- [ ] 日志轮转配置
- [ ] 监控告警设置

### 8.2 运维建议
- 定期检查回退状态文件
- 监控回退触发频率
- 及时处理配额和限速问题
- 定期更新模型配置

## 9. 风险评估

### 9.1 潜在风险
- 回退模型性能差异
- 配置错误导致服务中断
- 持久化文件损坏
- 并发访问竞态条件

### 9.2 缓解措施
- 充分的测试覆盖
- 配置验证机制
- 文件锁和备份策略
- 线程安全设计

## 10. 总结

本设计方案基于 `gemini-cli` 项目的成熟回退机制，结合 `bridge-server` 的现有架构，提供了一个完整的模型回退解决方案。通过分阶段实施，可以确保功能的稳定性和可靠性，同时保持与现有 API Key 轮换功能的良好集成。