# Gemini CLI MCP OpenAI Bridge 功能实现说明

## 项目概述

这是一个基于 TypeScript 开发的桥接服务器，主要功能是将 Google Gemini AI 模型通过 MCP (Model Context Protocol) 和 OpenAI 兼容的 API 接口对外提供服务。该项目支持多账号管理、智能配额轮换、安全策略控制等高级功能。

## 核心功能模块

### 1. MCP 桥接服务 (Bridge Service)

**文件位置**: `src/bridge/bridge.ts`

**主要功能**:
- 提供 MCP 协议兼容的接口，允许客户端通过 MCP 协议调用 Gemini 工具
- 支持会话管理，每个客户端连接维护独立的会话状态
- 工具注册和执行，包括文件操作、网络搜索、Shell 命令等
- 安全策略控制，根据配置的安全级别限制工具访问权限
- 重定向 URL 解析功能，自动解析搜索结果中的重定向链接

**关键特性**:
- 动态工具注册：根据安全策略动态注册可用工具
- 会话隔离：每个 MCP 会话独立管理，避免状态冲突
- 错误处理：完善的错误捕获和转换机制
- 日志记录：详细的操作日志和性能监控

### 2. OpenAI 兼容 API (OpenAI Compatible API)

**文件位置**: `src/bridge/openai.ts`

**主要功能**:
- 提供 OpenAI Chat Completions API 兼容接口
- 支持流式和非流式响应
- 工具调用支持，兼容 OpenAI 的 function calling 格式
- 模型列表查询接口

**API 端点**:
- `POST /v1/chat/completions` - 聊天完成接口
- `GET /v1/models` - 模型列表接口

**关键特性**:
- 流式响应：支持 Server-Sent Events (SSE) 流式输出
- 格式转换：自动将 Gemini 响应格式转换为 OpenAI 格式
- 工具调用：支持 function calling 和 tool use
- 错误映射：将 Gemini 错误映射为 OpenAI 标准错误格式

### 3. 多账号管理系统 (Multi-Account Management)

**文件位置**: `src/config/multiAccountManager.ts`, `src/config/enhancedConfig.ts`

**主要功能**:
- 支持多个 Gemini 账号的配置和管理
- 智能配额轮换，自动在账号间切换以避免配额限制
- 配额监控和统计，实时跟踪每个账号的使用情况
- Flash 模型回退机制，当 Pro 模型配额用完时自动切换到 Flash 模型

**轮换策略**:
- `round_robin`: 轮询策略，按顺序轮换账号
- `least_used`: 最少使用策略，优先使用配额剩余最多的账号
- `random`: 随机策略，随机选择可用账号

**关键特性**:
- 配额追踪：实时监控每个账号的 Pro 模型使用次数
- 自动切换：配额用完时自动切换到下一个可用账号
- 状态管理：维护账号的活跃、配额超限、禁用等状态
- 配置灵活：支持环境变量和配置文件两种配置方式

### 4. 安全策略控制 (Security Policy)

**文件位置**: `src/index.ts`, `src/bridge/bridge.ts`

**安全模式**:
- `read-only`: 只读模式，仅允许文件读取和搜索操作
- `edit`: 编辑模式，允许文件编辑但禁用 Shell 命令
- `configured`: 配置模式，根据配置文件中的策略控制工具访问
- `yolo`: 完全开放模式，允许所有操作（需要确认）

**关键特性**:
- 工具白名单：可配置允许使用的工具列表
- Shell 命令策略：可配置允许和禁止的 Shell 命令前缀
- MCP 代理控制：可控制是否允许访问外部 MCP 服务
- 交互式确认：高风险模式需要用户确认

### 5. 配置管理系统 (Configuration Management)

**文件位置**: `src/config/`

**配置类型**:
- 基础配置：继承自 gemini-cli-core 的标准配置
- 增强配置：添加多账号管理功能的扩展配置
- 多账号配置：专门用于多账号管理的配置
- 安全策略配置：工具访问控制和安全策略配置

**配置来源**:
- 环境变量：支持通过环境变量配置
- 配置文件：支持 JSON 格式的配置文件
- 命令行参数：支持命令行参数覆盖配置

### 6. 工具集成系统 (Tool Integration)

**支持的工具类型**:
- 文件操作：读取、写入、列表、搜索文件
- 网络操作：Web 搜索、网页抓取
- Shell 命令：执行系统命令（受安全策略控制）
- MCP 工具：集成外部 MCP 服务的工具

**工具特性**:
- 动态注册：根据安全策略动态注册可用工具
- 参数验证：使用 Zod 进行严格的参数类型验证
- 结果转换：自动将工具执行结果转换为 MCP 格式
- 错误处理：统一的错误处理和日志记录

## 技术架构

### 依赖关系

```
@google/gemini-cli-core     # 核心 Gemini CLI 功能
@modelcontextprotocol/sdk   # MCP 协议支持
express                     # Web 服务器框架
openai                      # OpenAI 类型定义
zod                         # 数据验证
undici                      # HTTP 客户端
```

### 服务启动流程

1. **参数解析**: 使用 yargs 解析命令行参数
2. **配置加载**: 加载基础配置、扩展配置和多账号配置
3. **安全检查**: 验证安全策略并显示警告
4. **认证初始化**: 初始化 Gemini API 认证
5. **服务启动**: 启动 MCP 桥接服务和 OpenAI API 服务
6. **工具注册**: 根据安全策略注册可用工具

### 请求处理流程

#### MCP 请求处理
1. 接收 MCP 协议请求
2. 会话管理和验证
3. 工具调用和参数验证
4. 安全策略检查
5. 执行工具并返回结果

#### OpenAI API 请求处理
1. 接收 HTTP 请求
2. 格式验证和转换
3. 调用 Gemini API
4. 流式或非流式响应处理
5. 格式转换并返回结果

## 部署和使用

### 启动命令

```bash
# 单账号模式
npm run start:single

# 多账号模式
npm run start:multi-account

# 调试模式
npm run debug
```

### 环境变量配置

```bash
# 基础配置
GEMINI_API_KEY=your_api_key
GEMINI_MCP_PORT=8765
GEMINI_TOOLS_DEFAULT_MODEL=gemini-2.5-pro

# 多账号配置
MULTI_ACCOUNT_ENABLED=true
ACCOUNT_1_NAME=account1
ACCOUNT_1_API_KEY=key1
# ... 更多账号配置
```

### 服务端点

- MCP 服务: `http://localhost:8765/mcp`
- OpenAI API: `http://localhost:8765/v1`
- 模型列表: `http://localhost:8765/v1/models`

## 监控和日志

### 日志功能
- 请求/响应日志
- 性能监控（响应时间）
- 错误追踪和堆栈信息
- 账号切换和配额使用日志
- 工具调用详细日志

### 监控指标
- 请求成功率
- 平均响应时间
- 账号配额使用情况
- 工具调用统计
- 错误率和错误类型分布

## 扩展性设计

### 插件化架构
- 工具系统支持动态注册
- 配置系统支持扩展
- 认证系统支持多种方式
- 安全策略支持自定义规则

### 可扩展组件
- 新的工具类型
- 新的认证方式
- 新的轮换策略
- 新的安全策略
- 新的配置来源

这个桥接服务器为 Gemini AI 模型提供了完整的企业级接入解决方案，支持多种协议、多账号管理、安全控制等高级功能，适用于各种规模的应用场景。